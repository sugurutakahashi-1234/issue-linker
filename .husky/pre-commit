echo "ðŸ¶ Husky: Running pre-commit checks..."

# Prevent direct commits to main
[ "$(git branch --show-current)" = "main" ] && echo "âŒ No direct commits to main!" && exit 1

# Fix and check code quality
bun run fix
bun run check
git diff --exit-code

# Validate codecov.yml if changed
if git diff --cached --name-only | grep -q "^codecov.yml$"; then
  bun run validate:codecov
fi

# Validate renovate.json5 if changed
if git diff --cached --name-only | grep -q "^renovate.json5$"; then
  bun run validate:renovate
fi

# Test GitHub Action if action.yml or test workflow changed
if git diff --cached --name-only | grep -qE "^action\.yml$|^\.github/workflows/local-test-action-marketplace\.yml$|^packages/action/.*\.ts$"; then
  echo "ðŸ§ª Testing GitHub Action with Act CLI..."
  
  # Check if act is installed
  if ! command -v act &> /dev/null; then
    echo "âš ï¸ Warning: 'act' CLI is not installed. Skipping action tests."
    echo "Install act to test GitHub Actions locally: https://github.com/nektos/act"
  else
    # Run the test with act
    if ! bun run test:action-marketplace; then
      echo "âŒ GitHub Action tests failed!"
      echo "Please fix the issues and try again."
      exit 1
    fi
    echo "âœ… GitHub Action tests passed!"
  fi
fi

# Auto-update dependency graph
if git diff --cached --name-only | grep -qE "^(packages|src)/.*\.ts$"; then
  bun run docs:update
  
  # Check if any docs were modified
  if ! git diff --exit-code docs/ > /dev/null 2>&1; then
    echo "ðŸ“Š Documentation has been updated."
    echo "Please review and stage the changes, then commit again:"
    echo "  git diff docs/"
    echo "  git add docs/"
    echo "  git commit"
    exit 1
  fi
fi
